### 背景
现在我们的业务，主要存两个数据源。现在两个数据源都是不稳定的存在。
例如写MySQL时，如果遇到其它部门误操作SQL造成，MySQL服务器CPU，loader过高。数据库服务器响应会非常慢。插入时会超时。
ES的话，现在线上ES服务器并不是特别稳定，也会有插入失败的场景。
而我们插入的数据，一部分是从kafka里面消费过来的，kafka的consumer是单线程，一个插入失败，会阻塞后面的消息消费失败，造成大量的报告未生成。 

### 解决方案

_之前方案_  
 
* 客户信息--->存入MySql--->MySql成功，同步存入ES--->失败，返回,成功--->异步调用外部风险引擎--->风险结果放入kafka  

* consumer消费，风险结果--->将风险结果，存入MySql，Es

_之前问题_    

* 之前出过几个问题，虽然数据源虽然都没有不可用，但是不稳定，造成数据写入较慢。MySQL写入并没有设置事务的超时时间，socket超时时间设置为1分钟，ES模板本身机制，如果超时会做重试三次，，每次超时时间为1分钟。  

* 我们整个流程是一个完整的商业事务。如果某一步比较慢，整个流程就会慢。  

* consumer消费是单线程，如果此时较慢会阻塞后面全部的消息，后面报告将生成不了。

_现在方案_    
 
* 认为MySQL可靠性强，ES可靠性差。MySQL作为主数据源，Es作为备用数据源。（高级搜索功能，必须是ES）  

* 基本信息写入操作，只写MySQL，写入设定超时，并把数据发送到kafka,用做写ES和做数据恢复。  

* 两个consumer，一个用于基本信息写入ES，一个基本信息写入MySQL。因为MySQL已经写过一次，如果数据库中已经存在，返回。这一步，是为了确保ES和MySQL基本信息都写入，所以有失败重试机制。如果超出失败重试的阀值，则记录到文件，用做数据恢复。    

* 风险详细信息，也是两个consumer，分别写ES，MySQL，MySQL风险详情与基本信息做过表的拆分，是写入操作，ES是更新操作。两个操作相同，都是插入/更新，失败，重试。超过阀值，记录日志。    

* 数据查询，先从MySQL中查询，并设置超时，如果查询超时，则查询ES。



