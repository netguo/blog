
### 背景
毕业一年，第一负责一个产品线的开发，并且是一个重要的产品线，由于经验不足，在上线的过程中，遇到诸多的问题，经过小伙伴们没日没夜的加班，最终成功上线。但也反映除了诸多的问题，为了避免在以后的产品发布中出现类似的问题，保证产品线的快速迭代的发布，对上线过程中遇到的问题做了一些总结。   

---

### 上线问题  
测试通过后，开始了线上发布的过程，在发布过程中可以总结为三个阶段：  

* 环境问题  
  * 在发布过程中，不断的遇到一些环境问题。
* 线上大数据量问题  
  * 线上线下不同的数据量，在加载数据，以及数据的规则匹配时，都有出现问题  
* 疑难问题 
  * 线上数据问题扫描，莫名其妙某一节点运行卡死  

---  

	  
### 解决方案    

##### 环境问题：  
解决方案：针对线上环境问题，逐步的联调，对代码一块一块的运行，定位到问题，然后解决问题。在这个过程中，spark线上测试，需要预先加载好前置数据，才能调试没一行的代码，浪费了较多的时间。

##### 数据量问题
解决方案：先限制了数据源加载的数量，暂时解决了数据源的加载问题。后期又通过先做数据清洗后匹配的方式彻底解决该问题。  
  
###### 疑难问题
解决方案：开始以为是hive中sql的join问题，后来定位，是某个十亿左右数据关联一个小表时，存在数据倾斜的问题。
	
---  
	  
	  
### 问题总结  

##### 上线流程  
现在的上线流程是，开发-自测-提测-测试-发布预发布环境-发布上线  
针对于较成熟的线上环境，基本的业务开发上线是没有问题，但是一个新的项目上线，往往会带来很多不确定的风险，为了避免这种不确定风险的发生，在上线之前，需要在线上真实环境做好充分的线上测试。所以对于一个新技术，新的项目的上线流程应该是，开发-自测-线上测试-提测-测试-发布预发布环境-上线。

##### 线上测试 
充分的线上测试会减小上线的压力，对于一个全新应用的产品，上线前做好线上测试尤为重要。针对这次的上线，做了以下的总结。

+ 提前把不同的环境所造成的问题解决，减小在发布上线过程中的压力。  
	  先不谈本次的spark的发布，当我们进行一次Java服务端应用的改造时，上线也往往会到12点以后。可以想象不同的环境所带来的问题，是不容小觑的。如果是一个新技术应用产品的发布，例如这次的spark，因为之前并上线经验不足，环境所带来的问题更为突出。如果能提前把环境问题解决，会减小避免上线过程中压力。
 
+ 避免线上真实数据量带来的性能风险。  
    看技术博时常常会看到一些如何搭建真实的线上压测环境，为何这些帖子这么的广泛，必然有它们存在原因。线上测试，不仅仅需要解决环境问题，还需要针对线上真实数据量所带来的压力，来验证应用的稳定性。在线下运行良好的应用，当提高应用所承载的压力，如Java应用中的并发量，spark离线扫描中的数据源数量，所带来的问题也是未知，不可预测的。对于这种不可预知的问题一旦发生，往往会带来不可以预知的痛苦。因为这种问题往往不好定位，难以解决。为避免这样的问题带来产品的延期，上线前做好充分的压力测试也是必须的。
 
+ 避免一门新的技术所带来的不确定风险。  
  在刚刚开始这个项目之前，跟一个做大数据的朋友聊过一次天，当向他讲起现在所做的项目时，他问了我几个问题。“你知道spark源码有多少行代码吗”，“你知道现在有多少公司使用了spark吗”，“你知道现在spark被大公司真正使用有几年了吗”。当时也没有太在意朋友的问题，现在回想起来，或许朋友是在善意的提醒我，这个项目上线时会有比较多风险存在。  
  现在开源技术火热，作为一个创业公司，人力资源有限的情况下，我们往往会采用较多的开源技术框架来搭建我们的平台。开源技术给我们带来很多的便利，但风险与便利同在。相对于环境问题，性能问题，新技术带来的风险将会带来更多困扰。如果网上有现成的解决方案是比较幸运的，如果并没有找个合适的解决方案，去做问题定位，只能是不断的尝试，或者通过查看源码去深层次的定位原因，这往往会带来较多的时间消耗。上线前做好线上测试，会将这些问题提前暴露出来，才会有充分的时间去解决这些问题。  
	
##### 进度与时间评估  
在评估项目进度时，也遇到诸多的问题，造成项目延期，当然没有进行线上测试是最根本的问题，具体做了如下的总结。 
  
+ 没有进行线上测试，这也是造成项目延期的最根本的原因。  
   对于线上测试的时间可以根据上线的项目做具体的评估，如果只是普通的产品迭代，提前一天在stg上做验证即可。但是一门新技术应用，并且可能有性能瓶颈，预留一周的线上测试是有必要的。	 
+ 没有及时的进入前后端联调。  
   本计划年前一周进行前后端的联调，由于前端忙于stark的开发，并没有及早的进入，造成年后开发压力大，进度紧急的情况。这样的情况，尽量的避免。
 	
+ 遇到问题没有及时的跟领导汇报。
	遇到难以解决的问题，没有及时的跟领导沟通。如果可以提前沟通，领导可以提前进行资源的调度，便于快速及时的解决问题。    
	
---	
	  
	  
### 一些收获    

##### 杞人忧天优于亡羊补牢  
《人月神话》中有句比较经典的话：所有的编程人员都有乐观主义，总是相信自己的代码是肯定能运行的。我觉得，这也是bug产生的最大的缘由。正因为有这样的问题存在，在预估自己开发的应用时，需要对所有预知的问题考虑全面，并且做好出现不能预知问题的准备，才会保证开发进度的正常运转。  
一个典型的案例：一个测试出现的bug，标明已解决，又被测试打回。

##### 玩与不玩之间划分明确的界限
相信很多程序员，都有一份技术情节，喜欢玩各种技术，这本身是一件非常值得尊重的行为。但是也要有所界限，毕竟公司的产品线稳定是首要因素，需要避免一些不必要的风险。

##### 开源技术具有不可控性 
在这次开发中，运用了较多的join操作，在真实上线时遇到一些问题。两个大数据量的join操作，遇到了性能瓶颈，但是对于spark中hive sql中join操作的具体的实现细节也具有较多的未知性，也难以去解决这个问题。我想这也是人力资源充沛的大公司所用的框架都是自己开发的原因吧，自己实现的框架可控性较强。	  

 

